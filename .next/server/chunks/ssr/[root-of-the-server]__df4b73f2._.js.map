{"version":3,"sources":["../../../../src/lib/file-upload.ts","../../../../src/app/actions/settings.ts"],"sourcesContent":["import { writeFile, mkdir } from \"fs/promises\";\r\nimport { join } from \"path\";\r\n\r\n/**\r\n * Salva um arquivo na pasta public/uploads/{folder}\r\n * @param file O arquivo vindo do formulário\r\n * @param folder O nome da subpasta (ex: 'news', 'team', 'banners')\r\n * @returns A URL pública para acessar a imagem (ex: /uploads/news/foto.jpg)\r\n */\r\nexport async function saveFile(file: File | null, folder: string = \"general\"): Promise<string> {\r\n  if (!file || typeof file !== \"object\" || !file.size) return \"\";\r\n\r\n  try {\r\n    const bytes = await file.arrayBuffer();\r\n    const buffer = Buffer.from(bytes);\r\n\r\n    // Limpa o nome do arquivo para evitar caracteres estranhos\r\n    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, \"_\");\r\n    // Cria um nome único: TIMESTAMP-NOME\r\n    const filename = `${Date.now()}-${safeName}`;\r\n\r\n    // Define o caminho no servidor: ./public/uploads/pasta\r\n    const uploadDir = join(process.cwd(), \"public\", \"uploads\", folder);\r\n    \r\n    // Cria a pasta se ela não existir\r\n    await mkdir(uploadDir, { recursive: true });\r\n\r\n    // Caminho completo do arquivo\r\n    const finalPath = join(uploadDir, filename);\r\n\r\n    // Grava o arquivo no disco\r\n    await writeFile(finalPath, buffer);\r\n\r\n    // Retorna o caminho público (URL)\r\n    return `/uploads/${folder}/${filename}`;\r\n  } catch (error) {\r\n    console.error(`Erro ao salvar arquivo em ${folder}:`, error);\r\n    return \"\";\r\n  }\r\n}","'use server'\r\n\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { revalidatePath } from \"next/cache\"\r\nimport { saveFile } from \"@/lib/file-upload\"\r\n\r\nexport async function updateSettings(formData: FormData) {\r\n  try {\r\n    const existing = await prisma.siteSettings.findFirst()\r\n    \r\n    const data = {\r\n      siteName: formData.get(\"siteName\") as string,\r\n      description: formData.get(\"description\") as string,\r\n      legalName: formData.get(\"legalName\") as string,\r\n      cnpj: formData.get(\"cnpj\") as string,\r\n      businessHours: formData.get(\"businessHours\") as string,\r\n      contactEmail: formData.get(\"contactEmail\") as string,\r\n      contactPhone: formData.get(\"contactPhone\") as string,\r\n      address: formData.get(\"address\") as string,\r\n      instagramUrl: formData.get(\"instagramUrl\") as string,\r\n      facebookUrl: formData.get(\"facebookUrl\") as string,\r\n      youtubeUrl: formData.get(\"youtubeUrl\") as string,\r\n      \r\n      // --- ADICIONE ESTES DOIS CAMPOS ---\r\n      impactedYouth: formData.get(\"impactedYouth\") as string,\r\n      yearsOfHistory: formData.get(\"yearsOfHistory\") as string,\r\n      // ----------------------------------\r\n    }\r\n\r\n    // SALVA LOGO NA PASTA \"settings\"\r\n    const file = formData.get(\"logo\") as File\r\n    let logoUrl = existing?.logoUrl\r\n\r\n    if (file && file.size > 0) {\r\n        logoUrl = await saveFile(file, \"settings\")\r\n    }\r\n\r\n    if (existing) {\r\n      await prisma.siteSettings.update({\r\n        where: { id: existing.id },\r\n        data: {\r\n            ...data,\r\n            ...(logoUrl && { logoUrl }) \r\n        }\r\n      })\r\n    } else {\r\n      await prisma.siteSettings.create({\r\n        data: {\r\n            ...data,\r\n            logoUrl\r\n        }\r\n      })\r\n    }\r\n\r\n    revalidatePath(\"/\")\r\n    revalidatePath(\"/admin/settings\")\r\n    revalidatePath(\"/projetos\") // <--- Adicionei para atualizar a página de projetos\r\n    \r\n    return { success: true }\r\n\r\n  } catch (error) {\r\n    console.error(\"Erro ao salvar configurações:\", error)\r\n    return { error: \"Falha ao salvar as configurações.\" }\r\n  }\r\n}\r\n\r\nexport async function updateInstagramSettings(formData: FormData) {\r\n  try {\r\n    const id = formData.get(\"id\") as string\r\n    let existing = null;\r\n\r\n    if (id) {\r\n       existing = await prisma.instagramSettings.findUnique({ where: { id } })\r\n    } else {\r\n       existing = await prisma.instagramSettings.findFirst()\r\n    }\r\n\r\n    const data = {\r\n      username: formData.get(\"username\") as string,\r\n      accessToken: formData.get(\"accessToken\") as string,\r\n      showFeed: formData.get(\"showFeed\") === \"on\", \r\n    }\r\n\r\n    if (existing) {\r\n      await prisma.instagramSettings.update({ where: { id: existing.id }, data })\r\n    } else {\r\n      await prisma.instagramSettings.create({ data })\r\n    }\r\n    \r\n    revalidatePath(\"/\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"Erro Instagram:\", error)\r\n    return { error: \"Erro ao salvar dados do Instagram.\" }\r\n  }\r\n}"],"names":[],"mappings":"gHAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAQO,eAAe,EAAS,CAAiB,CAAE,EAAiB,SAAS,EAC1E,GAAI,CAAC,GAAwB,UAAhB,OAAO,GAAqB,CAAC,EAAK,IAAI,CAAE,MAAO,GAE5D,GAAI,CACF,IAAM,EAAQ,MAAM,EAAK,WAAW,GAC9B,EAAS,OAAO,IAAI,CAAC,GAGrB,EAAW,EAAK,IAAI,CAAC,OAAO,CAAC,kBAAmB,KAEhD,EAAW,CAAA,EAAG,KAAK,GAAG,GAAG,CAAC,EAAE,EAAA,CAAU,CAGtC,EAAY,CAAA,EAAA,EAAA,IAAA,AAAI,EAAC,QAAQ,GAAG,GAAI,SAAU,UAAW,EAG3D,OAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,EAAW,CAAE,WAAW,CAAK,GAGzC,IAAM,EAAY,CAAA,EAAA,EAAA,IAAA,AAAI,EAAC,EAAW,GAMlC,OAHA,MAAM,CAAA,EAAA,EAAA,SAAA,AAAS,EAAC,EAAW,GAGpB,CAAC,SAAS,EAAE,EAAO,CAAC,EAAE,EAAA,CAAU,AACzC,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,CAAC,0BAA0B,EAAE,EAAO,CAAC,CAAC,CAAE,GAC/C,EACT,CACF,kECrCA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAEO,eAAe,EAAe,CAAkB,EACrD,GAAI,CACF,IAAM,EAAW,MAAM,EAAA,MAAM,CAAC,YAAY,CAAC,SAAS,GAE9C,EAAO,CACX,SAAU,EAAS,GAAG,CAAC,YACvB,YAAa,EAAS,GAAG,CAAC,eAC1B,UAAW,EAAS,GAAG,CAAC,aACxB,KAAM,EAAS,GAAG,CAAC,QACnB,cAAe,EAAS,GAAG,CAAC,iBAC5B,aAAc,EAAS,GAAG,CAAC,gBAC3B,aAAc,EAAS,GAAG,CAAC,gBAC3B,QAAS,EAAS,GAAG,CAAC,WACtB,aAAc,EAAS,GAAG,CAAC,gBAC3B,YAAa,EAAS,GAAG,CAAC,eAC1B,WAAY,EAAS,GAAG,CAAC,cAGzB,cAAe,EAAS,GAAG,CAAC,iBAC5B,eAAgB,EAAS,GAAG,CAAC,iBAE/B,EAGM,EAAO,EAAS,GAAG,CAAC,QACtB,EAAU,GAAU,QA2BxB,OAzBI,GAAQ,EAAK,IAAI,CAAG,GAAG,CACvB,EAAU,MAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,EAAM,WAAA,EAG/B,EACF,MAAM,EADM,AACN,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC,CAC/B,MAAO,CAAE,GAAI,EAAS,EAAG,AAAD,EACxB,KAAM,CACF,GAAG,CAAI,CACP,GAAI,GAAW,CAAE,SAAQ,CAAC,AAC9B,CACF,GAEA,MAAM,EAAA,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC,CAC/B,KAAM,CACF,GAAG,CAAI,SACP,CACJ,CACF,GAGF,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,KACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,mBACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,aAER,CAFqB,AAEnB,SAAS,CAAK,CAEzB,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,WALmE,qBAKlC,GACxC,CAAE,MAAO,mCAAoC,CACtD,CACF,CAEO,eAAe,EAAwB,CAAkB,EAC9D,GAAI,CACF,IAAM,EAAK,EAAS,GAAG,CAAC,MACpB,EAAW,KAGZ,EADC,EACU,EADN,IACY,EAAA,MAAM,CAAC,iBAAiB,CAAC,UAAU,CAAC,CAAE,MAAO,IAAE,CAAG,CAAE,GAE1D,MAAM,EAAA,MAAM,CAAC,iBAAiB,CAAC,SAAS,GAGtD,IAAM,EAAO,CACX,SAAU,EAAS,GAAG,CAAC,YACvB,YAAa,EAAS,GAAG,CAAC,eAC1B,SAAuC,OAA7B,EAAS,GAAG,CAAC,WACzB,EASA,OAPI,EACF,MAAM,EADM,AACN,MAAM,CAAC,iBAAiB,CAAC,MAAM,CAAC,CAAE,MAAO,CAAE,GAAI,EAAS,EAAE,AAAC,OAAG,CAAK,GAEzE,MAAM,EAAA,MAAM,CAAC,iBAAiB,CAAC,MAAM,CAAC,MAAE,CAAK,GAG/C,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,KACR,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,kBAAmB,GAC1B,CAAE,MAAO,oCAAqC,CACvD,CACF,0CAzFsB,EA4DA,IA5DA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MA4DA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA"}